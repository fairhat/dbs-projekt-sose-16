<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"controllers_HundeController.js.html":{"id":"controllers_HundeController.js.html","title":"Source: controllers/HundeController.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: controllers/HundeController.js 'use strict' const Hund = require('../models/Hund') const Boom = require('Boom') const moment = require('moment') /** * @name HundeController * @desc Controller für HundeViews * @class **/ class HundeController { /** * * @name findOne * @desc find one dog by id * @version 0.0.1 * @param {Request} req * @param {Response} res */ static findOne(req, res) { Hund.findOneWithRelations(req.params.id) .then((result) =&gt; { if (result) { res(result) } else { res(Boom.notFound('Hund nicht gefunden.')) } }) .catch((e) =&gt; res(e)) } /** * * @name randomDogs * @desc find random dogs * @version 0.0.1 * @param {Request} req * @param {Response} res */ static randomDogs(req, res) { const thisYear = parseInt(moment().format('YYYY'), 10) const maxAge = thisYear - parseInt(req.query.maxAge / 12, 10) Hund.getRandom(req.query.amount, maxAge) .then((dogs) =&gt; dogs.map(d =&gt; new Hund(d))) .then((dogs) =&gt; { if (dogs.length &gt; 0) { res(dogs) } else { res(Boom.notFound('Keine Hunde gefunden.')) } }).catch(res) } /** * * @name all * @desc get all dogs * @version 0.0.1 * @param {Request} req * @param {Response} res */ static all(req, res) { const direction = req.query.direction === 1 ? 'ASC' : 'DESC' const { page, itemsPerPage, sortBy } = req.query Hund.find(undefined, undefined, undefined, { [sortBy]: direction }, { page, itemsPerPage }) .then(res) .catch(res) } /** * * @name avg * @desc get dogs average points * @version 0.0.1 * @param {Request} req * @param {Response} res */ static avg(req, res) { const direction = req.query.direction === 1 ? 'ASC' : 'DESC' const { page, itemsPerPage } = req.query const offset = page * itemsPerPage const limit = itemsPerPage Hund.query(`SELECT AVG(ergebnisse.punkte)::int AS &quot;average&quot;, hunde.hid, hunde.name FROM hunde FULL JOIN ergebnisse ON ergebnisse.hund = hunde.hid GROUP BY hunde.hid, hunde.name ORDER BY average ${direction} OFFSET ${offset} LIMIT ${limit};`) .then(res) .catch(res) } /** * * @name races * @desc get dog races * @version 0.0.1 * @param {Request} req * @param {Response} res */ static races(req, res) { const direction = req.query.direction === 1 ? 'ASC' : 'DESC' const { page, itemsPerPage } = req.query const offset = page * itemsPerPage const limit = itemsPerPage Hund.query(`SELECT MAX(ergebnisse.punkte/ergebnisse.laeufe) AS &quot;best&quot;, hunde.hid AS &quot;hid&quot;, hunde.name AS &quot;name&quot; FROM hunde FULL JOIN ergebnisse ON ergebnisse.hund = hunde.hid GROUP BY hunde.hid, hunde.name ORDER BY best ${direction} OFFSET ${offset} LIMIT ${limit};`) .then(res) .catch(console.error) } /** * * @name children * @desc get data to children of dogs * @version 0.0.1 * @param {Request} req * @param {Response} res */ static children(req, res) { const parent = req.query.gender === 'm' ? 'vater' : 'mutter' const { page, itemsPerPage } = req.query const offset = page * itemsPerPage const limit = itemsPerPage const direction = req.query.direction === 1 ? 'ASC' : 'DESC' const top = req.query.top Hund.query(`SELECT MAX(ergebnisse.punkte/ergebnisse.laeufe) AS &quot;best&quot;, parent.hid AS &quot;parentId&quot;, parent.name AS &quot;parentName&quot;, string_agg(child.name, ', ') AS &quot;children&quot; FROM hunde AS parent FULL JOIN hunde AS child ON parent.hid = child.${parent} FULL JOIN ergebnisse ON ergebnisse.hund = child.hid FULL JOIN rennen ON rennen.rid = ergebnisse.rennen WHERE child.${parent} IS NOT NULL AND ergebnisse.rang &lt;= ${top} GROUP BY parent.name, parent.hid ORDER BY best ${direction} OFFSET ${offset} LIMIT ${limit};`) .then(res) .catch(res) } } module.exports = HundeController × Search results Close "},"migrations_02_import_csv.js.html":{"id":"migrations_02_import_csv.js.html","title":"Source: migrations/02_import_csv.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: migrations/02_import_csv.js 'use strict' const DB = require('./../lib/database') const fs = require('fs') const _ = require('lodash') const ImportData = require('./../models/importdata.js') const ImportZwinger = ImportData.ImportZwinger const CSV = readCSV() const DOGS = createDogs(CSV) const UNIQUEDOGS = createUniqueDogs(DOGS) const ZWINGER = createImportZwinger(UNIQUEDOGS) const RACES = createRaces(DOGS) /** * @desc importiert die Hunde in die Datenbank */ function importDogs() { return new Promise((resolve, reject) =&gt; { let counter = 1 const insertVars = UNIQUEDOGS.map((dog) =&gt; dog.transformToSQLInsert()) const queryVars = insertVars.map((v, i) =&gt; `(${v.map(k =&gt; { const count = counter counter = counter + 1 return `$${count}` }).join(',')})`).join(',') const QUERY = ` INSERT INTO hunde (hid, name, geschlecht, geburtsjahr, geburtsland, aufenthaltsland) VALUES ${queryVars}; ` DB.query(QUERY, _.flatten(insertVars), (err) =&gt; { if (err) { reject(err) } else { resolve('Hunde importiert') console.log('Hunde importiert') } }) }) } /** * @desc updated vater/mutter der hunde in die db */ function updateMomDad() { return new Promise((resolve, reject) =&gt; { const DogDad = UNIQUEDOGS.map(({ id, vaterID }) =&gt; `WHEN ${id} THEN ${vaterID}`).join('\\n ') const DogMom = UNIQUEDOGS.map(({ id, mutterID }) =&gt; `WHEN ${id} THEN ${mutterID}`).join('\\n ') const UpdateMomDad = ` UPDATE hunde SET vater = CASE hid ${DogDad} ELSE null END; UPDATE hunde SET mutter = CASE hid ${DogMom} ELSE null END ` // fs.writeFileSync('./momDad.sql', UpdateMomDad, 'utf8') DB.query(UpdateMomDad, (err) =&gt; { if (err) { reject(err) } else { resolve('Eltern aktualisiert') console.log('Eltern aktualisiert') } }) }) } /** * @desc fügt zwinger in die db */ function insertZwinger() { return new Promise((resolve, reject) =&gt; { let counter = 1 const zwingerInserts = ZWINGER.map(({ id, name }) =&gt; ([id, name])) const zwingerVars = zwingerInserts.map(() =&gt; { const id = counter counter = counter + 1 const name = counter counter = counter + 1 return `($${id}, $${name})` }).join(',') const QUERY = ` INSERT INTO zwinger (zid, name) VALUES ${zwingerVars}; ` DB.query(QUERY, _.flatten(zwingerInserts), (err) =&gt; { if (err) { reject(err) } else { resolve('Zwinger importiert') console.log('Zwinger importiert') } }) }) } /** * @desc setzt beziehung hunde -&gt; zwinger */ function updateHundeZwinger() { return new Promise((resolve, reject) =&gt; { const DogZwinger = UNIQUEDOGS.map(({ id, zwingerID }) =&gt; `WHEN ${id} THEN ${zwingerID}`).join('\\n ') const UpdateZwinger = ` UPDATE hunde SET zwinger = CASE hid ${DogZwinger} ELSE null END; ` // fs.writeFileSync('./momDad.sql', UpdateZwinger, 'utf8') DB.query(UpdateZwinger, (err) =&gt; { if (err) { reject(err) } else { resolve('Hunde -&gt; Zwinger aktualisiert') console.log('Hunde -&gt; Zwinger aktualisiert') } }) }) } /** * @desc fügt ergebnisse hinzu */ function insertResults() { return new Promise((resolve, reject) =&gt; { let counter = 1 const inserts = DOGS.map((({ id, avgDistance, name, rang, sumPoints, raceCountry, raceYear, runCount, }) =&gt; { const dog = UNIQUEDOGS.find(d =&gt; d.name === name) const race = RACES.find(({ year, country }) =&gt; year === raceYear &amp;&amp; country === raceCountry) return [ id, avgDistance, rang, dog.id, race.id, sumPoints, runCount ] })) const vars = inserts.map((x) =&gt; { // ES6 Magic, Array Comprehension -&gt; [Array from 1 to length of x] const vars = x.map((y) =&gt; { const count = counter counter += 1 return '$' + count }) return `(${vars.join(', ')})` }).join(',') const QUERY = ` INSERT INTO ergebnisse (eid, distanz, rang, hund, rennen, punkte, laeufe) VALUES ${vars} ` DB.query(QUERY, _.flatten(inserts), (err) =&gt; { if (err) reject(err) else { resolve('Ergebnisse importiert') console.log('Ergebnisse importiert') } }) }) } /** * @desc fügt rennen hinzu */ function insertRaces() { return new Promise((resolve, reject) =&gt; { let counter = 1 const raceInserts = RACES.map((({ id, year, country }) =&gt; ([id, year, country]))) const raceVars = raceInserts.map((z) =&gt; { const id = counter counter = counter + 1 const year = counter counter = counter + 1 const country = counter counter = counter + 1 return `($${id}, $${year}, $${country})` }).join(',') const QUERY = ` INSERT INTO rennen (rid, jahr, ort) VALUES ${raceVars}; ` DB.query(QUERY, _.flatten(raceInserts), (err) =&gt; { if (err) { reject(err) } else { resolve('Rennen importiert') console.log('Rennen importiert') } }) }) } /** * @desc löscht alle tabellen */ function dropTables () { return new Promise((resolve, reject) =&gt; { DB.query(` DELETE FROM ergebnisse; DELETE FROM hunde; DELETE FROM zwinger; DELETE FROM rennen; `, (err) =&gt; { if (err) { reject(err) } else { resolve('Tabellen geleert') console.log('Tabellen geleert') } }) }) } /** * @desc füllt die hundedaten in-memory */ function fillInitialDogData() { console.log('Bereite CSV Datei für import vor') UNIQUEDOGS.forEach((dog) =&gt; { UNIQUEDOGS.forEach(({id, name}) =&gt; { // finde vater und mutter eines hundes if (name === dog.mutter) { dog.mutterID = id return; } if (name === dog.vater) { dog.vaterID = id return; } }) const myZwinger = ZWINGER.find(zw =&gt; zw.name === dog.zwinger) dog.zwingerID = myZwinger ? myZwinger.id : null }) return Promise.resolve() } /** * @param {Array} Args * @desc main funktion */ function main(args) { return fillInitialDogData() .then(dropTables) .then(importDogs) .then(updateMomDad) .then(insertZwinger) .then(updateHundeZwinger) .then(insertRaces) .then(insertResults) .then(() =&gt; console.log('Fertig! Alle Daten wurden von der CSV importiert.')) .catch((err) =&gt; console.error(err)) } /** * @desc Read CSV Datei */ function readCSV() { return fs.readFileSync(__dirname + './../data/greyhounddata.csv', 'utf8') .split('\\n') .map(x =&gt; x.split(';')) } /** * @desc Erstellt Hunde Instanzen */ function createDogs(csvfile) { return CSV.map((row, index) =&gt; new ImportData(index + 1, row)) } /** * @desc findet alle unique hunde */ function createUniqueDogs(dogs) { return _.uniqBy(dogs, 'name') } /** * @desc erstellt zwinger Instanzen */ function createImportZwinger(uniqDogs) { return _.uniqBy(uniqDogs, 'zwinger') .map((z) =&gt; z.zwinger) .filter((z) =&gt; z &amp;&amp; z.length &gt; 0) .map((name, id) =&gt; new ImportZwinger({ name, id: id + 1 })) } /** * @desc erstellt rennen */ function createRaces(dogs) { return (_.uniqBy(dogs, 'raceYearCountry')).map(({ raceYear, raceCountry }, index) =&gt; ({ year: raceYear, country: raceCountry, id: index + 1 })) } module.exports = main module.exports.cmd = 'csv' module.exports.description = `Liest die greyhounddata.csv ein und importiert die Daten in das relationale Datenbankschema Befehl: npm run migrations -- -n=csv` × Search results Close "},"migrations_01_create_tables.js.html":{"id":"migrations_01_create_tables.js.html","title":"Source: migrations/01_create_tables.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: migrations/01_create_tables.js 'use strict' const DB = require('./../lib/database') const fs = require('fs') const SQLQuery = fs.readFileSync(__dirname + './../data/create_db.sql', 'utf8') /** * @desc Führt Funktion zum erzeugen der Tabelle aus * @return undefined */ function createTables() { console.log('Tabellen werden erstellt...') return new Promise((resolve, reject) =&gt; { DB.query(SQLQuery, (err, result) =&gt; { if (err) { reject(err) } else { resolve('Tabellen in der Datenbank erstellt.') console.log('Tabellen in der Datenbank erstellt') } }) }) } /** * @desc main funktion für migration */ function main() { return createTables().catch((e) =&gt; { console.log(`Fehler beim Erstellen der Tabellen... \\nMögliche Ursachen: \\n1. Datenbank existiert nicht.\\n2. Keine Verbindung zur Datenbank möglich.\\n3. Tabellen existieren bereits`) console.log('Stacktrace:') console.error(e) throw e; }) } module.exports = main module.exports.cmd = 'tbl' module.exports.description = `Erstellt die Tabellen (Hunde, Zwinger, etc.) in der Datenbank Befehl: npm run migrations -- -n=tbl` × Search results Close "},"models_DBModel.js.html":{"id":"models_DBModel.js.html","title":"Source: models/DBModel.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: models/DBModel.js 'use strict' const Query = require('./Query') /** * @desc DBModel Base Class */ class DBModel { constructor(props = {}) { Object.keys(props).forEach((prop) =&gt; this[prop] = props[prop]) } /** * * @desc get table name, muss von kindern überschrieben werden * @static **/ static get tableName() { console.warn(`NO TABLENAME SET FOR ${this.constructor.name}`) return '' } /** * * @desc get id field - muss überschrieben werden * @static * */ static get idField() { console.warn(`NO IDFIELD SET FOR ${this.constructor.name}`) return '' } /** * @desc finde ein modell über die id */ static findOneById(id = 0) { return this.findOne(this.idField, `= ${id}`) } /** * * @desc finde alle instanzen eines modells * */ static getAll() { return this.find() } /** * * @desc findet eine instanz mit verschiedenen bedingungen * @param {String} fieldName * @param {String} condition * @param {String|Array} fields * @param {Object} sortBy */ static findOne( fieldName = '', condition = '', fields = '*', sortBy = {} ) { if (condition.length &gt; 0) { return (new Query()) .select(fields) .from(this.tableName) .where(`${fieldName} ${condition}`) .limit(1) .orderBy(sortBy) .done() .then(([first, ...rest]) =&gt; first) } else { return Promise.resolve(null) } } /** * * @desc finde mehrere instanzen mit den bedingungen * @param {String} fieldName * @param {String} condition * @param {String|Array} fields * @param {Object} sortBy */ static find( fieldName = '', condition = '', fields = '*', sortBy = {}, { page, itemsPerPage } = {} ) { return (new Query()) .select(fields) .from(this.tableName) .where(`${fieldName} ${condition}`) .orderBy(sortBy) .paginate(page, itemsPerPage) .done() } /** * @desc führe RAW SQL Query auf Modell aus * @param {String} queryString */ static query(queryString) { return Query.q(queryString) } toString() { return JSON.stringify(this) } } module.exports = DBModel × Search results Close "},"models_Ergebnis.js.html":{"id":"models_Ergebnis.js.html","title":"Source: models/Ergebnis.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: models/Ergebnis.js 'use strict' const DBModel = require('./DBModel') const Hund = require('./Hund') const Rennen = require('./Rennen') /** * * @desc Ergebnis Modell * * */ class Ergebnis extends DBModel { /** * @desc Public constructor */ constructor({ eid = '', distanz = 0, rang = 0, hund = null, rennen = null, punkte = 0, laeufe = 0 } = {}) { super({ eid, distanz, rang, hund, rennen, punkte, laeufe }) } /** * @desc einen hund zu einem ergebnis finden */ getHund() { return Hund.findOneById(this.hund) } /** * @desc finde das rennen zum ergebnis */ getRennen() { return Rennen.findOneById(this.rennen) } static get tableName() { return 'ergebnisse' } static get idField() { return 'eid' } static get fields() { return [ 'eid', 'distanz', 'rang', 'hund', 'rennen', 'punkte', 'laeufe' ] } } module.exports = Ergebnis × Search results Close "},"models_Query.js.html":{"id":"models_Query.js.html","title":"Source: models/Query.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: models/Query.js 'use strict' const DB = require('../lib/database') /** * @name Query * @desc Query Builder Klasse * @version 0.0.1 */ class Query { constructor(props) { this.QUERY = '' this.paginateActive = false this.page = 0 this.itemsPerPage = 50 } /** * * Verwandelt JSON Condition Objekt in * SQL Select statements * @name select * @version 0.0.1 * @example (new Query()).select('col1 col2 col3') oder (new Query()).select(['col1', 'col2']) * @param {Array|string} select - Select condition(s) */ select(columns = ['*']) { // columns -&gt; Array wenn nur String übergeben const _cols = Array.isArray(columns) ? columns : columns.split(' ') this.QUERY += `SELECT ${_cols.join(',') } ` return this } /** * * @name from * @version 0.0.1 * @param {String} table * @example (new Query()).select().from('table') */ from(table = '') { if (table.length &gt; 0) { this.QUERY += `FROM ${table} ` } return this } /** * * @name where * @version 0.0.1 * @param {String} condition * @example (new Query()).select().from('table').where('x NOT NULL') */ where(condition = '') { if (condition.length &gt; 1) { this.QUERY += `WHERE ${condition} ` } return this } /** * @param {Number} size * @return {Query} this */ offset(size = 0) { this.QUERY += `OFFSET ${size} ` return this } /** * @desc order by query * @param {Object} fieldObject */ orderBy(fieldObject = {}) { const fields = Object.keys(fieldObject) if (fields.length &gt; 0) { const qry = fields.map((fieldName) =&gt; { const direction = fieldObject[fieldName] return `${fieldName} ${direction} ` }).join(', ') this.QUERY += `ORDER BY ${qry}` } return this } /** * @desc limit query * @param {Number} limit */ limit(size = 50) { this.QUERY += `LIMIT ${size}` return this } /** * @desc paginate query * @param {Number} page * @param {Number} itemsPerpage */ paginate(page, itemsPerpage) { if (typeof page !== 'undefined' &amp;&amp; itemsPerpage) { this.offset(page * itemsPerpage) this.limit(itemsPerpage) } return this } /** * @desc print sql query */ print() { console.log(`DBQuery :: &quot;${this.QUERY}&quot;`) return this } /** * @desc raw query * @param {String} queryString */ query(queryString) { this.QUERY += queryString return this } /** * @param {String} query */ done(query = this.QUERY) { const qry = query + ';' this.print() return new Promise((resolve, reject) =&gt; { DB.query(qry, (err, rows) =&gt; { if (err) { reject(err) } else { if (this.paginateActive) { const result = { rows: rows.rows, paginated: true, page: this.page, itemsPerpage: this.itemsPerPage } resolve(result) } resolve(rows.rows) } }) }) } /** * @desc run and execute raw query * @param {String} queryString */ static q(queryString) { return (new Query()).query(queryString).done() } } module.exports = Query × Search results Close "},"models_Hund.js.html":{"id":"models_Hund.js.html","title":"Source: models/Hund.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: models/Hund.js 'use strict' const DBModel = require('./DBModel') const Ergebnis = require('./Ergebnis') const Zwinger = require('./Zwinger') /** * @desc Hundemodell */ class Hund extends DBModel { constructor({ hid = '', name = '', geschlecht = 'm', geburtsjahr = 1970, geburtsland = 'UNKNOWN', aufenthaltsland = 'UNKNOWN', vater = null, mutter = null, zwinger = null, ergebnisse = [], rennen = [] } = {}) { super({ hid, name, geschlecht, geburtsjahr, geburtsland, aufenthaltsland, vater, mutter, zwinger, ergebnisse, rennen }) } /** * @desc rufe mutter eines hundes ab */ getMutter() { if (this.mutter) { return Hund.findOneById(this.mutter) } return Promise.resolve(null) } /** * @desc rufe vater eines hundes ab */ getVater() { if (this.vater) { return Hund.findOneById(this.vater) } return Promise.resolve(null) } /** * @desc rufe ergebnisse eines hundes ab */ getErgebnisse() { if (this.ergebnisse.length === 0) { const fieldName = 'ergebnisse.hund' const condition = `= ${this.hid}` return Ergebnis.find(fieldName, condition) } else return Promise.resolve(this.ergebnisse) // Cached } /** * @desc rufe rennen eines hundes ab */ getRennen() { return this .getErgebnisse() .then((ergebnisse) =&gt; Promise.all(ergebnisse.map(erg =&gt; (new Ergebnis(erg)).getRennen()))) } /** * @desc rufe zwinger eines hundes ab */ getZwinger() { if (this.zwinger) { return Zwinger.findOneById(this.zwinger) } return Promise.resolve(null) } /** * @desc Finde einen Hund mit all seinen beziehungen * @param {String} id */ static findOneWithRelations(id) { return Hund .findOneById(id) .then((dog) =&gt; { if (dog) { const DogInstance = new Hund(dog) return DogInstance .getMutter() .then((mutter) =&gt; { DogInstance.mutter = mutter || null return DogInstance.getVater() }) .then((vater = null) =&gt; { DogInstance.vater = vater || null return DogInstance.getErgebnisse() }) .then((ergebnisse) =&gt; { DogInstance.ergebnisse = ergebnisse return DogInstance.getRennen() }) .then((rennen) =&gt; { DogInstance.rennen = rennen return DogInstance }) } else return null }) } /** * @desc get random dogs * @param {Number} amount * @param {Number} maxAge */ static getRandom(amount, maxAge) { return Hund.query(` SELECT * FROM ${this.tableName} WHERE geburtsjahr &gt;= ${maxAge} AND (SELECT COUNT(*) FROM ergebnisse WHERE ergebnisse.hund = hid) &gt; 4 ORDER BY RANDOM() LIMIT ${amount};`) .then((dogs) =&gt; { const DogInstances = dogs.map(d =&gt; new Hund(d)) return Promise.all(DogInstances.map(d =&gt; d.getMutter())) .then((mothers) =&gt; { mothers.filter(m =&gt; m).forEach((mother) =&gt; { const Child = DogInstances.find(d =&gt; d.mutter == mother.hid) Child.mutter = mother }) return Promise.all(DogInstances.map(d =&gt; d.getVater())) }) .then((fathers) =&gt; { fathers.filter(f =&gt; f).forEach((father) =&gt; { const Child = DogInstances.find(d =&gt; d.vater == father.hid) Child.vater = father }) return Promise.all(DogInstances.map(d =&gt; d.getZwinger())) }) .then((zwingers) =&gt; { zwingers.filter(f =&gt; f).forEach((zwi) =&gt; { const Child = DogInstances.find(d =&gt; d.zwinger == zwi.zid) Child.zwinger = zwi }) return Promise.all(DogInstances.map(d =&gt; d.getErgebnisse())) }) .then((ergebnisse) =&gt; { ergebnisse.forEach((ergebnis) =&gt; { const Child = DogInstances.find(d =&gt; d.hid == ergebnis[0].hund) Child.ergebnisse = ergebnis }) return Promise.all(DogInstances.map(d =&gt; d.getRennen())) }) .then((rennen) =&gt; { rennen.forEach((run) =&gt; { const Child = DogInstances.find(d =&gt; d.ergebnisse.find(e =&gt; e.rennen == run[0].rid)) Child.rennen = run }) return DogInstances }) }) } static get tableName() { return 'hunde' } static get idField() { return 'hid' } static get fields () { return [ 'hid', 'name', 'geschlecht', 'geburtsjahr', 'geburtsland', 'aufenthaltsland', 'vater', 'mutter', 'zwinger' ] } } module.exports = Hund × Search results Close "},"models_importdata.js.html":{"id":"models_importdata.js.html","title":"Source: models/importdata.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: models/importdata.js /******************************************** * Import Klasse, initialisierte * Objekte stellen jeweils eine Zeile in der * CSV Datei dar. ******************************************** * * @name ImportData * @desc Importdata klasse * ********************************************/ class ImportData { constructor(id, [ raceCountry, year, place, displayName, gender, vater, mutter, runCount, punkte, distanz ] = []) { const fullName = displayName.split('[')[0].trim() const BornLivesAge = displayName.split('[')[1].replace(']', '') const knownAufenthalt = BornLivesAge.indexOf('/') !== -1 const birthYear = parseInt(BornLivesAge.split(' ')[1], 10) const geburtsland = knownAufenthalt ? BornLivesAge.split('/')[0] : BornLivesAge.split(' ')[0] const aufenthaltsland = knownAufenthalt ? (BornLivesAge.split('/')[1] || '').split(' ')[0] : null const { zwinger, name } = ImportData.getName(fullName) this.id = id this.raceCountry = raceCountry this.year = birthYear this.rang = parseInt(place, 10) this.displayName = displayName this.geschlecht = gender ? (gender.toLowerCase() === 'm' ? 'm' : 'f') : 'm' this.vater = vater this.mutter = mutter this.runCount = parseInt(runCount, 10) this.sumPoints = parseInt(Math.round(punkte), 10) this.avgDistance = distanz ? parseInt(distanz.replace('\\r', ''), 10) : 0 this.geburtsland = geburtsland this.aufenthaltsland = aufenthaltsland this.zwinger = zwinger this.name = name this.raceYear = year this.raceYearCountry = `${year}${raceCountry}` this.zwingerID = null this.vaterID = null this.mutterID = null this.wurf = null } transformToSQLInsert() { return [ this.id, this.name, this.geschlecht, this.year, this.geburtsland, this.aufenthaltsland ] } static getName(fullName) { const words = fullName.split(' ') // trennt die einzelnen Bereiche der Spalte // ist in einem der Namen ein Apostroph, gehen wir davon aus, dass das der Zwingername ist // und dass der ZwingerName vor dem Hundenamen steht const hasZwingerFirst = words.find(word =&gt; word.indexOf(`'s`) !== -1) || false // 2 Wörter im Namen und der Zwingername ist *nicht* als erstes // Schema: [DogName] [ZwingerName] if (words.length === 2 &amp;&amp; !hasZwingerFirst) { const zwinger = [...words] // copy words const name = zwinger.shift() return { zwinger: zwinger.join(' '), name: name.trim(), } } // 2 oder mehr Wörter und Zwingername zuerst // Schema: [ZwingerName]'s [DogName] if (words.length &gt;= 2 &amp;&amp; hasZwingerFirst) { const name = [...words] const zwinger = name.shift() return { zwinger, name: name.join(' ').trim() } } // kein Zwinger vorhanden, Zwinger (NULL) return { name: words.join(' ').trim(), zwinger: null } } } module.exports = ImportData /** * @desc importzwinger klasse */ class ImportZwinger { constructor({ id, name }) { this.id = id this.name = name } } module.exports.ImportZwinger = ImportZwinger × Search results Close "},"controllers_ZwingerController.js.html":{"id":"controllers_ZwingerController.js.html","title":"Source: controllers/ZwingerController.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: controllers/ZwingerController.js 'use strict' const Boom = require('Boom') /** * @name ZwingerController * @class * @desc Controller für Zwinger Views */ class ZwingerController { /** * * @name index * @desc index of zwinger * @version 0.0.1 * @param {Request} req * @param {Response} res */ static index(req, res) { return res() } static getTop(req, res) { res() } } module.exports = ZwingerController × Search results Close "},"config.example.js.html":{"id":"config.example.js.html","title":"Source: config.example.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: config.example.js /** * CONFIG Datei */ module.exports = { /** * Datenbank Konfiguration */ database: { host: 'localhost', user: 'postgres', pass: 'password', port: 5432, db: 'dograce', }, /** * Backend Server Konfiguration */ server: { port: 8000, host: 'localhost', routes: { cors: { origin: ['*'] }, } }, /** * Frontend */ frontend: { port: 80, host: '0.0.0.0', }, } × Search results Close "},"config.js.html":{"id":"config.js.html","title":"Source: config.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: config.js /** * CONFIG Datei */ module.exports = { /** * Datenbank Konfiguration */ database: { host: 'localhost', user: 'postgres', pass: 'myU4tN93', port: 5432, db: 'dograce', }, /** * Backend Server Konfiguration */ server: { port: 8000, host: 'localhost', routes: { cors: { origin: ['*'] }, } }, /** * Frontend */ frontend: { port: 80, host: '0.0.0.0', }, } × Search results Close "},"migrations_index.js.html":{"id":"migrations_index.js.html","title":"Source: migrations/index.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: migrations/index.js 'use strict' const tbl = require('./01_create_tables.js') const csv = require('./02_import_csv.js') /** * export migrations */ module.exports = { tbl, csv, } module.exports.ALL = [ tbl, csv ] × Search results Close "},"models_Rennen.js.html":{"id":"models_Rennen.js.html","title":"Source: models/Rennen.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: models/Rennen.js 'use strict' const DBModel = require('./DBModel') /** * @name Rennen */ class Rennen extends DBModel { constructor({ rid = '', jahr = 0, ort = '' } = {}) { super({ rid, jahr, ort }) } static get tableName() { return 'rennen' } static get idField() { return 'rid' } static get fields() { return [ 'rid', 'jahr', 'ort' ] } } module.exports = Rennen × Search results Close "},"models_Zwinger.js.html":{"id":"models_Zwinger.js.html","title":"Source: models/Zwinger.js","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Source: models/Zwinger.js 'use strict' const DBModel = require('./DBModel') /** * @desc Zwingermodell */ class Zwinger extends DBModel { constructor({ zid = '', name = 0 } = {}) { super({ zid, name }) } static get tableName() { return 'zwinger' } static get idField() { return 'zid' } static get fields() { return [ 'zid', 'name', ] } } module.exports = Zwinger × Search results Close "},"global.html":{"id":"global.html","title":"Global","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Global Members all get all dogs Version: 0.0.1 Source: controllers/HundeController.js, line 55 avg get dogs average points Version: 0.0.1 Source: controllers/HundeController.js, line 71 children get data to children of dogs Version: 0.0.1 Source: controllers/HundeController.js, line 127 findOne find one dog by id Version: 0.0.1 Source: controllers/HundeController.js, line 13 from Version: 0.0.1 Source: models/Query.js, line 37 Example (new Query()).select().from('table') index index of zwinger Version: 0.0.1 Source: controllers/ZwingerController.js, line 11 Query Query Builder Klasse Version: 0.0.1 Source: models/Query.js, line 4 races get dog races Version: 0.0.1 Source: controllers/HundeController.js, line 99 randomDogs find random dogs Version: 0.0.1 Source: controllers/HundeController.js, line 33 Rennen Source: models/Rennen.js, line 4 select Verwandelt JSON Condition Objekt inSQL Select statements Version: 0.0.1 Source: models/Query.js, line 19 Example (new Query()).select('col1 col2 col3') oder (new Query()).select(['col1', 'col2']) where Version: 0.0.1 Source: models/Query.js, line 52 Example (new Query()).select().from('table').where('x NOT NULL') Methods createDogs() Erstellt Hunde Instanzen Source: migrations/02_import_csv.js, line 312 createImportZwinger() erstellt zwinger Instanzen Source: migrations/02_import_csv.js, line 326 createRaces() erstellt rennen Source: migrations/02_import_csv.js, line 336 createTables() Führt Funktion zum erzeugen der Tabelle aus Source: migrations/01_create_tables.js, line 11 Returns: undefined createUniqueDogs() findet alle unique hunde Source: migrations/02_import_csv.js, line 319 dropTables() löscht alle tabellen Source: migrations/02_import_csv.js, line 239 fillInitialDogData() füllt die hundedaten in-memory Source: migrations/02_import_csv.js, line 260 importDogs() importiert die Hunde in die Datenbank Source: migrations/02_import_csv.js, line 17 insertRaces() fügt rennen hinzu Source: migrations/02_import_csv.js, line 201 insertResults() fügt ergebnisse hinzu Source: migrations/02_import_csv.js, line 145 insertZwinger() fügt zwinger in die db Source: migrations/02_import_csv.js, line 83 main(Args) main funktion Parameters: Name Type Description Args Array Source: migrations/02_import_csv.js, line 287 main() main funktion für migration Source: migrations/01_create_tables.js, line 28 readCSV() Read CSV Datei Source: migrations/02_import_csv.js, line 303 updateHundeZwinger() setzt beziehung hunde -&gt; zwinger Source: migrations/02_import_csv.js, line 117 updateMomDad() updated vater/mutter der hunde in die db Source: migrations/02_import_csv.js, line 49 × Search results Close "},"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Classes Classes DBModel Ergebnis Hund HundeController ImportZwinger Zwinger ZwingerController × Search results Close "},"index.html":{"id":"index.html","title":"Index","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere × Search results Close "},"DBModel.html":{"id":"DBModel.html","title":"Class: DBModel","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Class: DBModel DBModel new DBModel() DBModel Base Class Source: models/DBModel.js, line 7 Members &lt;static&gt; idField get id field - muss überschrieben werden Source: models/DBModel.js, line 29 &lt;static&gt; tableName get table name, muss von kindern überschrieben werden Source: models/DBModel.js, line 18 Methods &lt;static&gt; find(fieldName, condition, fields, sortBy) finde mehrere instanzen mit den bedingungen Parameters: Name Type Description fieldName String condition String fields String | Array sortBy Object Source: models/DBModel.js, line 86 &lt;static&gt; findOne(fieldName, condition, fields, sortBy) findet eine instanz mit verschiedenen bedingungen Parameters: Name Type Description fieldName String condition String fields String | Array sortBy Object Source: models/DBModel.js, line 58 &lt;static&gt; findOneById() finde ein modell über die id Source: models/DBModel.js, line 37 &lt;static&gt; getAll() finde alle instanzen eines modells Source: models/DBModel.js, line 46 &lt;static&gt; query(queryString) führe RAW SQL Query auf Modell aus Parameters: Name Type Description queryString String Source: models/DBModel.js, line 106 × Search results Close "},"Ergebnis.html":{"id":"Ergebnis.html","title":"Class: Ergebnis","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Class: Ergebnis Ergebnis new Ergebnis() Ergebnis Modell Source: models/Ergebnis.js, line 12 Methods getHund() einen hund zu einem ergebnis finden Source: models/Ergebnis.js, line 32 getRennen() finde das rennen zum ergebnis Source: models/Ergebnis.js, line 39 × Search results Close "},"Hund.html":{"id":"Hund.html","title":"Class: Hund","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Class: Hund Hund new Hund() Hundemodell Source: models/Hund.js, line 9 Methods &lt;static&gt; findOneWithRelations(id) Finde einen Hund mit all seinen beziehungen Parameters: Name Type Description id String Source: models/Hund.js, line 81 &lt;static&gt; getRandom(amount, maxAge) get random dogs Parameters: Name Type Description amount Number maxAge Number Source: models/Hund.js, line 118 getErgebnisse() rufe ergebnisse eines hundes ab Source: models/Hund.js, line 50 getMutter() rufe mutter eines hundes ab Source: models/Hund.js, line 30 getRennen() rufe rennen eines hundes ab Source: models/Hund.js, line 61 getVater() rufe vater eines hundes ab Source: models/Hund.js, line 40 getZwinger() rufe zwinger eines hundes ab Source: models/Hund.js, line 70 × Search results Close "},"HundeController.html":{"id":"HundeController.html","title":"Class: HundeController","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Class: HundeController HundeController new HundeController() Controller für HundeViews Source: controllers/HundeController.js, line 6 × Search results Close "},"ImportZwinger.html":{"id":"ImportZwinger.html","title":"Class: ImportZwinger","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Class: ImportZwinger ImportZwinger new ImportZwinger() importzwinger klasse Source: models/importdata.js, line 112 × Search results Close "},"Zwinger.html":{"id":"Zwinger.html","title":"Class: Zwinger","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Class: Zwinger Zwinger new Zwinger() Zwingermodell Source: models/Zwinger.js, line 7 × Search results Close "},"ZwingerController.html":{"id":"ZwingerController.html","title":"Class: ZwingerController","body":" Dograce DBS SoSe 16 Classes DBModelErgebnisHundHundeControllerImportZwingerZwingerZwingerController Global allavgchildrencreateDogscreateImportZwingercreateRacescreateTablescreateUniqueDogsdropTablesfillInitialDogDatafindOnefromimportDogsindexinsertRacesinsertResultsinsertZwingermainQueryracesrandomDogsreadCSVRennenselectupdateHundeZwingerupdateMomDadwhere Class: ZwingerController ZwingerController new ZwingerController() Controller für Zwinger Views Source: controllers/ZwingerController.js, line 4 × Search results Close "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
